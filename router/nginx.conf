worker_processes  1;

events { worker_connections  1024; }

http {
  server_tokens off;
  client_max_body_size 100m;

  # ---- Rate limiting / connection limiting ----
  # Per-IP request rate limiting zones
  limit_req_zone $binary_remote_addr zone=upload_rate:10m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=read_rate:10m rate=50r/s;

  # Per-IP concurrent connection limiting zone
  limit_conn_zone $binary_remote_addr zone=perip_conn:10m;

  # Request ID: prefer incoming X-Request-Id, otherwise use nginx-generated $request_id
  map $http_x_request_id $req_id {
    default $http_x_request_id;
    ""      $request_id;
  }

  upstream upload_api {
    server upload-api:5000;
    keepalive 16;
  }

  server {
    listen 80;

    location = /health {
      return 200 "ok\n";
      add_header Content-Type text/plain;
    }

    location /upload/ {
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      # Rate limit uploads (per IP)
      limit_req zone=upload_rate burst=20 nodelay;
      limit_conn perip_conn 20;

      # Large uploads: avoid premature timeouts
      proxy_read_timeout 600s;
      proxy_send_timeout 600s;
      send_timeout 600s;

      # Propagate Request ID + client identity
      proxy_set_header X-Request-Id $req_id;

      proxy_request_buffering off;
      proxy_buffering off;

      proxy_pass http://upload_api;
    }

    location /files/ {
      alias /data/uploads/;
      autoindex off;
      try_files $uri =404;
      add_header Cache-Control "public, max-age=60";
    }
  }
}
